---
import "../styles/global.css";
const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrSFTPPJReYiIN2PWZuLwiDnLO_75ZeH8B27r5jjFIq0V8HgSa3LlbbD4NuJ2hbMzLBA/exec";

const PARTY = {
  cumpleanera: "Lya Khalesy",
  edad: "6",
  fecha: "Domingo 4 de Enero",
  hora: "4:30 PM",
  lugar: "Mz. 03 Lote 15 Urb. Los Jazmines",
  incluye: ["PiÃ±ata y dulces", "Juegos y premios", "Snacks y gaseosa", "Sorpresitas Kuromi"],
  mapsUrl: "https://maps.app.goo.gl/mE68saYUG4gpmjT69",
  whatsappUrl: "https://wa.me/51939464736?text=Hola%20tengo%20una%20consulta%20sobre%20la%20fiesta%20de%20Lya",
};
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>InvitaciÃ³n Lya</title>
    <link rel="icon" type="image/png" href="/kuromi-logo.png" />
  </head>

  <body>
    <div class="stars"></div>

    <main class="container">
      <section class="card">
        <div class="confetti"></div>

        <div class="header">
          <div>
            <div class="badge" id="badgePhone">ğŸ€ InvitaciÃ³n</div>
            <h1 class="title">CumpleaÃ±os de Lya ğŸ’œ</h1>
            <p class="subtitle" id="subtitle">Confirma tu asistencia para ver todos los detalles âœ¨</p>
          </div>
        </div>

        <div class="stepDots">
          <div class="dot" id="d1"></div>
          <div class="dot" id="d2"></div>
          <div class="dot" id="d3"></div>
        </div>

        <div class="content">
          <div class="grid">
            <div class="panel fadeIn" id="panelLeft"></div>

            <div class="panel kitty fadeIn">
              <div class="blob"></div>
              <div class="kuromiWrap">
                <div class="sparkles"></div>
                <img class="kuromiImg" src={`${import.meta.env.BASE_URL}images/kuromi.png`} alt="Kuromi" />
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script define:vars={{ APP_SCRIPT_URL, PARTY }}>
      const state = {
        step: 1,
        edadInvitado: "",
        nombre: "",
        apellido: "",
        parentezco: "amigos",
        acompananNinos: "no", // "no" por defecto
        cantidadNinos: "",
      };

      const el = {
        badgePhone: document.getElementById("badgePhone"),
        subtitle: document.getElementById("subtitle"),
        panelLeft: document.getElementById("panelLeft"),
        d1: document.getElementById("d1"),
        d2: document.getElementById("d2"),
        d3: document.getElementById("d3"),
      };

      function getQueryParam(key) {
        const u = new URL(window.location.href);
        return u.searchParams.get(key) || "";
      }

      function setDots(step) {
        [el.d1, el.d2, el.d3].forEach((d, i) => {
          d.classList.toggle("active", i + 1 === step);
        });
      }

      function escapeHtml(str) {
        return (str || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }

      function gotoConfirmado() {
        localStorage.setItem("kuromi_confirmed", "1");

        // construye /confirmado respetando subcarpeta de GitHub Pages
        const basePath = window.location.pathname.replace(/\/$/, "");
        const url = new URL(
          `${window.location.origin}${basePath}/confirmado`,
          window.location.origin
        );

        url.searchParams.set("nombre", state.nombre.trim());
        url.searchParams.set("apellido", state.apellido.trim());
        url.searchParams.set("par", state.parentezco);

        window.location.href = url.toString();
      }

      function render() {
        setDots(state.step);

        el.badgePhone.textContent = state.edadInvitado
          ? `ğŸˆ Edad: ${state.edadInvitado}`
          : `ğŸ€ InvitaciÃ³n`;


        if (state.step === 1) {
          el.subtitle.textContent = "Entra, confirma tu asistencia y desbloquea la invitaciÃ³n âœ¨";
          el.panelLeft.innerHTML = `
            <div class="fadeIn">
              <h2 style="margin:0 0 8px;">Â¡Holiii! ğŸ’œ</h2>
              <p style="margin:0; opacity:.92; line-height:1.45;">
                Esta es una invitaciÃ³n sÃºper especial. Primero confirma tu asistencia
                y luego verÃ¡s todos los detalles de la fiesta ğŸ‰
              </p>

              <div class="notice" style="margin-top:14px;">
                <b>Importante:</b> Completa tus datos para confirmar tu asistencia ğŸ’œ
              </div>


              <div class="footerActions">
                <button class="btn" id="btnStart" type="button">Â¡Empezar!</button>
              </div>
            </div>
          `;

          document.getElementById("btnStart").onclick = () => {
            state.step = 2;
            render();
          };
        }

        if (state.step === 2) {
          el.subtitle.textContent = "Completa tus datos y elige tu parentezco ğŸ’«";
          el.panelLeft.innerHTML = `
            <div class="fadeIn">
              <h2 style="margin:0 0 10px;">ConfirmaciÃ³n</h2>

              <div class="row">
                <div>
                  <p class="label">Nombre</p>
                  <input class="input" id="nombre" placeholder="Ej: Andrea" value="${escapeHtml(state.nombre)}" />
                </div>
                <div>
                  <p class="label">Apellido</p>
                  <input class="input" id="apellido" placeholder="Ej: Torres" value="${escapeHtml(state.apellido)}" />
                </div>
                 <div>
                  <p class="label">Edad</p>
                  <input class="input" id="edadInvitado" inputmode="numeric" placeholder="Ej: 25" value="${escapeHtml(state.edadInvitado)}" />
                </div>
              </div>

              <div style="margin-top:12px;">
                  <p class="label">Â¿Le acompaÃ±an niÃ±os?</p>
                  <div class="choice">
                    <label class="pill ${state.acompananNinos === "no" ? "active" : ""}" id="pillNinosNo">
                      <input type="radio" name="acomp_ninos" value="no" ${state.acompananNinos === "no" ? "checked" : ""}/>
                      âŒ No
                    </label>

                    <label class="pill ${state.acompananNinos === "si" ? "active" : ""}" id="pillNinosSi">
                      <input type="radio" name="acomp_ninos" value="si" ${state.acompananNinos === "si" ? "checked" : ""}/>
                      âœ… SÃ­
                    </label>
                  </div>

                  ${
                    state.acompananNinos === "si"
                      ? `
                        <div style="margin-top:10px;">
                          <p class="label">Â¿CuÃ¡ntos niÃ±os le acompaÃ±an?</p>
                          <input class="input" id="cantidadNinos" inputmode="numeric" placeholder="Ej: 2" value="${escapeHtml(state.cantidadNinos)}" />
                        </div>
                      `
                      : ""
                  }
                </div>

              <div style="margin-top:12px;">
                <p class="label">Parentezco con la cumpleaÃ±era</p>
                <div class="choice">
                  <label class="pill ${state.parentezco === "amigos" ? "active" : ""}" id="pillAmigos">
                    <input type="radio" name="parentezco" value="amigos" ${state.parentezco === "amigos" ? "checked" : ""}/>
                    ğŸ‘¯ Amigos
                  </label>
                  <label class="pill ${state.parentezco === "familia" ? "active" : ""}" id="pillFamilia">
                    <input type="radio" name="parentezco" value="familia" ${state.parentezco === "familia" ? "checked" : ""}/>
                    ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Familia
                  </label>
                </div>
              </div>              

              <div class="notice" style="margin-top:14px;">
                Al confirmar, se guardarÃ¡ tu asistencia en la lista.
              </div>

              <div class="footerActions">
                <button class="btn secondary" id="btnBack" type="button">AtrÃ¡s</button>
                <button class="btn" id="btnConfirm" type="button">Confirmar invitaciÃ³n âœ…</button>
              </div>
            </div>
          `;

          const nombre = document.getElementById("nombre");
          const apellido = document.getElementById("apellido");
          const edadInvitado = document.getElementById("edadInvitado");
          const pillNinosNo = document.getElementById("pillNinosNo");
          const pillNinosSi = document.getElementById("pillNinosSi");

          nombre.oninput = (e) => (state.nombre = e.target.value);
          apellido.oninput = (e) => (state.apellido = e.target.value);
          edadInvitado.oninput = (e) => {
            // solo nÃºmeros y mÃ¡ximo 2 dÃ­gitos (opcional)
            state.edadInvitado = (e.target.value || "").replace(/\D/g, "").slice(0, 2);
            e.target.value = state.edadInvitado;
          };

          const cantidadNinos = document.getElementById("cantidadNinos");
          if (cantidadNinos) {
            cantidadNinos.oninput = (e) => {
              state.cantidadNinos = (e.target.value || "").replace(/\D/g, "").slice(0, 2);
              e.target.value = state.cantidadNinos;
            };
          }
          pillNinosNo.onclick = () => {
            state.acompananNinos = "no";
            state.cantidadNinos = ""; // reset
            render();
          };

          pillNinosSi.onclick = () => {
            state.acompananNinos = "si";
            render();
          };


          document.getElementById("pillAmigos").onclick = () => {
            state.parentezco = "amigos";
            render();
          };
          document.getElementById("pillFamilia").onclick = () => {
            state.parentezco = "familia";
            render();
          };

          document.getElementById("btnBack").onclick = () => {
            state.step = 1;
            render();
          };

          document.getElementById("btnConfirm").onclick = async () => {
            const n = (state.nombre || "").trim();
              const a = (state.apellido || "").trim();
              const ed = (state.edadInvitado || "").trim();

              if (!n || !a) {
                alert("Por favor escribe tu nombre y apellido ğŸ’œ");
                return;
              }

              if (!ed) {
                alert("Por favor escribe tu edad ğŸˆ");
                return;
              }

              if (state.acompananNinos === "si") {
                const cn = (state.cantidadNinos || "").trim();
                if (!cn) {
                  alert("Â¿CuÃ¡ntos niÃ±os le acompaÃ±an? ğŸ‘§ğŸ§’");
                  return;
                }
              }

            state.step = 3;
            render();
            await sendToSheet();
            gotoConfirmado();
          };
        }

        if (state.step === 3) {
          el.subtitle.textContent = "Guardando tu confirmaciÃ³nâ€¦ ğŸ’Œ";
          el.panelLeft.innerHTML = `
            <div class="fadeIn">
              <h2 style="margin:0 0 10px;">Â¡Yei! âœ¨</h2>
              <p style="margin:0; opacity:.92; line-height:1.45;">
                Estamos guardando tu confirmaciÃ³n en la listaâ€¦
              </p>

              <div style="margin-top:14px; display:flex; gap:10px; align-items:center;">
                <div style="width:14px;height:14px;border-radius:50%; background:rgba(255,255,255,.18); position:relative; overflow:hidden;">
                  <div style="width:14px;height:14px;border-radius:50%; background:linear-gradient(90deg,var(--pink),var(--cyan)); animation: spin 1s linear infinite;"></div>
                </div>
                <div style="opacity:.9;">Un segundito ğŸ’œ</div>
              </div>

              <style>
                @keyframes spin{ from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
              </style>

              <div class="notice" style="margin-top:14px;">
                Si por alguna razÃ³n tu navegador bloquea la respuesta, igual quedarÃ¡ guardado.
              </div>
            </div>
          `;
        }
      }

      const pageWithExtras = (() => {
        const u = new URL(window.location.href);

        u.searchParams.set("edadInvitado", state.edadInvitado);

        u.searchParams.set("acomp_ninos", state.acompananNinos);
        if (state.acompananNinos === "si") {
          u.searchParams.set("cant_ninos", state.cantidadNinos || "0");
        } else {
          u.searchParams.delete("cant_ninos");
        }

        return u.toString();
      })();

      async function sendToSheet() {
        try {
          // âœ… Solo texto (no URL)
          const kidsInfo =
            state.acompananNinos === "si"
              ? `ninos: si | cantidad: ${state.cantidadNinos}`
              : "ninos: no";

          const payload = {
            phone: state.edadInvitado, // sigues guardando edad en "phone"
            nombre: state.nombre.trim(),
            apellido: state.apellido.trim(),
            parentezco: state.parentezco,
            userAgent: navigator.userAgent,
            page: kidsInfo, // âœ… aquÃ­ guardamos SOLO la info de niÃ±os
            notes: "",
          };

          await fetch(APP_SCRIPT_URL, {
            method: "POST",
            redirect: "follow",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
        } catch (err) {
          console.warn("No se pudo enviar (o CORS bloqueÃ³ lectura).", err);
        }
      }


      // Init
      state.edadInvitado = "";
      render();

      // Si ya confirmaron antes, manda directo a confirmado (sin reenviar)
      if (localStorage.getItem("kuromi_confirmed") === "1") {
        gotoConfirmado();
      }      

    </script>
  </body>
</html>
